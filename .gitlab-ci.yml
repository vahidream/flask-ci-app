stages:
  - deploy

variables:
  DEPLOY_SERVER: "192.168.11.139"
  DEPLOY_USER: "deployuser"
  DEPLOY_PATH: "/home/deployuser/flask-ci-app"

before_script:
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
  - chmod 600 ~/.ssh/id_rsa
  - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts

deploy:
  stage: deploy
  script:
    - echo "Deploy edilir..."
    - rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./ $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_PATH/
    - ssh $DEPLOY_USER@$DEPLOY_SERVER "cd $DEPLOY_PATH && docker-compose down && docker-compose up --build -d"
